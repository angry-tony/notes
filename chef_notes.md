# Resources

[http://nathenharvey.com/blog/2012/12/06/learning-chef-part-1/](http://nathenharvey.com/blog/2012/12/06/learning-chef-part-1/) \\
[http://devops.rackspace.com/cooking-with-chef2.html#.URK_Klpdc1u](http://devops.rackspace.com/cooking-with-chef2.html#.URK_Klpdc1u) \\
[http://wiki.opscode.com/display/chef/Guide+to+Creating+A+Cookbook+and+Writing+A+Recipe](http://wiki.opscode.com/display/chef/Guide+to+Creating+A+Cookbook+and+Writing+A+Recipe) \\
[http://wiki.opscode.com/display/chef/Resources](http://wiki.opscode.com/display/chef/Resources) \\
[http://wiki.opscode.com/display/chef/EC2+Bootstrap+Fast+Start+Guide](http://wiki.opscode.com/display/chef/EC2+Bootstrap+Fast+Start+Guide)\\
[https://github.com/opscode/knife-ec2](https///github.com/opscode/knife-ec2)\\
[http://wiki.opscode.com/display/chef/OpenStack+Bootstrap+Fast+Start+Guide](http://wiki.opscode.com/display/chef/OpenStack+Bootstrap+Fast+Start+Guide)\\
# Misc Commands

NOTE: This is assuming you're using "hosted chef"

__Install__

Install on EL 5/6

	
	root@host# curl -L https://www.opscode.com/chef/install.sh | bash


__set up client__

From your Chef Workstation

	
	root@host# knife bootstrap `<node name>` -x root -P `<password>`


__Upload New Recipe__

	
	root@host# knife cookbook upload `<recp name>`


__Add Recipe to Node__

	
	root@host# export EDITOR=vi knife node edit `<node name>`


Make sure you put the comma for multiple cookbooks (Example)

	
	{
	  "name": "itdb.4over.com",
	  "chef_environment": "_default",
	  "normal": {
	    "tags": [
	
	    ]
	  },
	  "run_list": [
	    "recipe[apache2]",
	    "recipe[php]"
	  ]
	}


__Set Up Client__

Run run_list on the client

	
	root@host# chef-client


Run specific recipes (*NOTE:* if your recipe depends on other recipes this might not work out)

	
	root@host# chef-client -o 'recipe[httpd]'


You can run more than one by delimiting them with a comma

	
	root@host# chef-client -o 'recipe[httpd],recipe[vsftpd]'


__Create CookBook__

	
	root@host# knife cookbook create `<name>`


Sample NTP cookbook

Step One:Run the create command

	
	root@host# knife cookbook create ntp


This creates a directory structure for the ntp cookbook. You can check it out with ls:

	
	root@host#  ls -la cookbooks/ntp/
	total 24
	drwxr-xr-x  13 someara  staff   442 Mar 14 17:56 .
	drwxr-xr-x  36 someara  staff  1224 Mar 15 19:39 ..
	-rw-r--r--   1 someara  staff    58 Mar 14 17:56 README.rdoc
	drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 attributes
	drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 definitions
	drwxr-xr-x   3 someara  staff   102 Mar 14 17:56 files
	drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 libraries
	-rw-r--r--   1 someara  staff   259 Mar 14 17:56 metadata.rb
	drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 providers
	drwxr-xr-x   4 someara  staff   136 Mar 14 17:56 recipes
	drwxr-xr-x   2 someara  staff    68 Mar 14 17:56 resources
	drwxr-xr-x   3 someara  staff   102 Mar 14 17:56 templates`</code>`
	
	Step Two : Deciding what to name the recipe
	
	Recipe names are related to cookbook structure. Putting recipe[foo::bar] in a node’s run list results in cookbooks/foo/recipes/bar.rb being downloaded from chef-server and executed.
	
	There is a special recipe in every cookbook called default.rb. It is executed either by specifying recipe[foo] or recipe[foo::default] explicitly.
	
	Default.rb is a good place to put common stuff when writing cookbooks with multiple recipes, but we’re going to keep it simple and just use default.rb for everything.
	
	Step Three : Creating a recipe
	
	This is where all the fun stuff happens. When using resources, you’re writing things in a declarative fashion. Declarative means you can concentrate on the WHAT without having to worry about the HOW. Chef will take care of that for you with something called a resource provider. When installing a package, it will check to see what your operating system is and use the appropriate methodology. For example, on Debian based systems, it will use apt-get, and on Redhat based systems, it will use yum.
	
	`<code>`
	
	root@host# vim cookbooks/ntp/recipes/default.rb
	 
	package "ntp" do
	    action [:install]
	end
	 
	template "/etc/ntp.conf" do
	    source "ntp.conf.erb"
	    variables( :ntp_server => "time.nist.gov" )
	    notifies :restart, "service[ntpd]"
	end
	 
	service "ntpd" do
	    action [:enable,:start]
	end


Chef recipes are evaluated top down (like a normal ruby program), with each resource being run in the order it appears. Order is important. In the above example, if we were to reverse the order of those three resources, it would first fail to start the service (as the software is not installed yet), then write the configuration file, then finally clobber the file it just wrote by installing the package.

Step Four : Creating the ntp.conf.erb template

	
	root@host#  vim cookbooks/ntp/templates/default/ntp.conf.erb
	 
	# generated by Chef.
	restrict default kod nomodify notrap nopeer noquery
	restrict -6 default kod nomodify notrap nopeer noquery
	restrict 127.0.0.1
	restrict -6 ::1
	server `<%= @ntp_server %>`
	server  127.127.1.0     # local clock
	driftfile /var/lib/ntp/drift
	keys /etc/ntp/keys


Step Five : uploading the cookbook to chef-server

	
	root@host# knife cookbook upload ntp


Step Six: Edit node config

`<code>`root@host# export EDITOR=vi knife node edit `<node name>`

{
    "name": "itdb.4over.com",
    "chef_environment": "_default",
    "normal": {
    "tags": [

    ]
    },
    "run_list": [
    "recipe[apache2]",
    "recipe[ntp]",
    "recipe[php]"
    ]
}


`</code>`

__Re-adding a Client/Node__

If you reinstalled a server; but want to use the same name (i.e. like in 4over when we rotated servers)

First

	
	root@host# rm ~/.ssh/known_hosts


Then

	
	root@host# knife node delete itdb.4over.com


One more...

	
	root@host# knife client delete itdb.4over.com


__Recipe - Create Dir__

First you make/edit your // ${cookbook}/attributes/default.rb // file (this is like a "function" file - i.e. procs.proto file) to add definitions

	
	efault[:panda][:data_dir]  = "/data/"
	default[:panda][:vhost_dir]   = "/etc/httpd/conf.d/vhosts/"
	default[:panda][:root_ssh_dir]   = "/root/.ssh/"


Then somewhere in your // ${cookbook}/recipes/default.rb // (or `<recipename>`.rb file) do something like this

	
	# Make sure these directories exist
	directory node[:panda][:data_dir] do
	  owner "root"
	  group "webbie"
	  mode "0775"
	  action :create
	end
	directory node[:panda][:vhost_dir] do
	  owner "root"
	  group "webbie"
	  mode "0775"
	  action :create
	end
	directory node[:panda][:root_ssh_dir] do
	  owner "root"
	  group "root"
	  mode "0700"
	  action :create
	end


To ensure files exist...look at the NTP example above.

__Symlink__

Use the "link" directive.

	
	# Create SymLink
	# ln -s /data/fundink/ /data/panda
	link "/data/panda" do
	  to "/data/fundink"
	end
	#


__Copy File__

Put your file under // ${cookbook}/files/default/sharutils-4.7-6.1.el6.i686.rpm.erb //

Then use the // cookbook_file // directive

	
	# Make sure we install the right package
	cookbook_file "/usr/local/src/sharutils-4.7-6.1.el6.i686.rpm" do
	    source "sharutils-4.7-6.1.el6.i686.rpm.erb"
	    owner "root"
	    group "root"
	    mode "0644"
	end
	#


If this is an RPM you can install it with the exec commant

	
	#
	# Install the sharutils
	execute "install sharutils" do
	    command "yum -y localinstall /usr/local/src/sharutils-4.7-6.1.el6.x86_64.rpm --nogpgcheck"
	    creates "/usr/bin/uuencode"
	    action :run
	end
	#
	#-30-


The // creates "/usr/bin/uuencode" // will make it only run once

__Adding Run List form CMD__

You can add a runlist from the command line

	
	me@workstation$ knife node run_list add jj.la3.4over.com 'recipe[base], recipe[httpd], recipe[vsftpd], recipe[php533], recipe[perl], recipe[fundink_config], recipe[sshkeys]'


__Chef "Kick"__

You can "control" your node with the knife command (isn't the knife command great?)

You can use this functionality to do something analogus to the "puppet kick" command.

	
	user@workstation$ knife ssh 'name:aardvark.4over.com' 'chef-client' -P secret -x root 


Basic syntax is // ** 'name:`<name of node>` 'command to run' -P `<node password>` -x `<user name>` ** //

__Add recipes while bootstraping__

Add recipes while bootstraping to save time!

	
	knife bootstrap -x root -P piranha -r recipe[4overbase::gln],recipe[access::sys],recipe[sudobase] chrish.sbx.4over.com


__Connect to EC2__

Follow this [link](http://wiki.opscode.com/display/chef/EC2+Bootstrap+Fast+Start+Guide) \\
OR This [link](https///github.com/opscode/knife-ec2)

Set up knife

	
	[chrish@aardvark 4overbase]$ cat /etc/git/sysops/chef/.chef/knife.rb 
	current_dir = File.dirname(__FILE__)
	log_level                :info
	log_location             STDOUT
	environment		 '4over'
	node_name                'sysops'
	client_key               '/etc/git/sysops/chef/.chef/sysops.pem'
	validation_client_name   'chef-validator'
	validation_key           '/etc/git/sysops/chef/.chef/chef-validator.pem'
	chef_server_url          'https://chef-server.4over.com'
	syntax_check_cache_path  '/etc/git/sysops/chef/.chef/syntax_check_cache'
	cookbook_path            ["#{current_dir}/../cookbooks"]
	knife[:aws_ssh_key_id] = "chef"
	knife[:aws_access_key_id]     = "AKIBUBSBOR6QQLVTR7VQ"
	knife[:aws_secret_access_key] = "fq9d7WP+8oQ65AmQuetfhwzPvqlrB01rimjusoo0"


Create server

	
	knife ec2 server create -I ami-0129cc68 -f m1.large  -i /etc/git/sysops/chef/.chef/chef.pem 


List servers

	
	[chrish@aardvark 4overbase]$ knife ec2 server list
	Instance ID  Name            Public IP      Private IP    Flavor    Image         SSH Key   Security Groups  State  
	i-9b5394f8   Jenkins Master  107.20.30.107  10.39.90.143  m1.large  ami-3788465e  darrellh  only-4over       running
	


__Create and assign Roles__

You can create roles which has one or many cookbooks/recipes

First create role...

	
	knife role create wsgln


Now edit it and add your runlists

	
	{
	  "name": "wsgln",
	  "description": "Windsurfer Frontend Webserver GLN",
	  "json_class": "Chef::Role",
	  "default_attributes": {
	  },
	  "override_attributes": {
	  },
	  "chef_type": "role", 
	  "run_list": [
	    "recipe[4overbase::gln]",
	    "recipe[access::dev]",
	    "recipe[cron::base]",
	    "recipe[ul4::prod]",
	    "recipe[sudobase]",
	    "recipe[httpd::wsprod]",
	    "recipe[vsftpd]",
	    "recipe[php533]",
	    "recipe[perl]",
	    "recipe[mounts::wsprod]",
	    "recipe[sshkeys]",
	    "recipe[pgbouncer::wsprod]"
	  ],
	  "env_run_lists": {
	  }
	}


Now add it to a server...

	
	knife node run_list add  sparrow.4over.com 'role[wsgln]'


Or boot strap it

	
	knife bootstrap -x root -P piranha -r 'role[wsgln]' sparrow.4over.com


__Searching__

You can search for which nodes have a particular recipe

	
	knife search node recipes:cron


More complex recipes require single quotes (like if you have a recipe named *access::sys*)

	
	knife search node 'recipes:access\:\:sys'


You can also search by other criteria...like *role*

	
	knife search node role:sandbox


You can search for the following...


*  Environment

*  FQDN

*  IP

*  Run List

*  Roles

*  Recipes

*  Platform

*  Tags

# Private Chef

You can have you own Chef Server (called "Private Chef") so that you don't have to go out to the internet to the hosted solution.

__Configure Server__

First go to [http://www.opscode.com/chef/install/](http://www.opscode.com/chef/install/) and click on the "Server" tab to get started.

Remember to have


*  Forward and Reverse DNS Set up

*  Firewall Ports Open

*  Host name fully resolvable

*  Set hostname so that **IS** set to the FQDN

*  A Server (Ubuntu/Centos) with a "minimum" set up (you don't want package conflicts)

Download the installer and do these 2 "easy" steps

 1.  Install the file using the correct method for your system (i.e. "dpkg -i chef-server.deb" for Debian)
 2.  sudo chef-server-ctl reconfigure

Once that it is installed; go to the web interface and create a user (make them an admin). Remember to copy your private key as it will not be shown again (if you forget you can regenerate it)
and save it as *USERNAME.pem*

	
	
	USERNAME.pem 
	
	-----BEGIN RSA PRIVATE KEY-----
	MIIEpAIBAAKCAQEAzljLbkjJ7ZY5T/ZcaEdKpMLwQQjcIJ0RD7FOWHCiYzr5UJVf
	GurceS575AKFdi3MWxmvvtaCNk9B8TmDi2YH/1CsFKubStgpjTsfZ2TYSKQAbfLO
	TTjTAMr/d+o++BZn3Ew/Bge6BLtRmPeUF+IGG7Be3kRPvQUKwNzG0xotUV1g3SgK
	ZKBgKdqJU7UInfNdXkRKv7JwEK5wPJQsDUa0g9GmEx5u0m3wSRT7K9D3CJBsr21g
	T7XQiJIZCWTbPswLMj2gvs+VctijolFmXAnMTr36hwranUU0qTo2raNuKWxvbPYw
	qvShoHhUiwu4f0l3EHPf1qntBYKOZWOFRfv+JQIDAQABAoIBAQCobCl/VsIavmcB
	MWCzbJ0sZkCblJO3uvvWBy6fWS/yNoyQjZsW6WQTNTHCJZyxnSgTo5+i8ItPsNlt
	/zezbBBTAJG0PW1/ZXhk4kD7r4ApqlL/axOgTCVNnGNwiS3kaMVVNpaqYVwfyJUN
	eebSp5W8u/RzDubWrWrdiFZwsAkVQt6nhKWFNLU3dvcyY0RNKimyomwfM/VD1IAX
	GWNTuGlBLcN/2RgpsdSfpVNTWsOPoB5MQbQyXAXZEGO3S2m5tz1dffVbCvJATXJ1
	Uk+BzywBSWcIv+und7+6Dm3ji58ICTOa2Eqhv+sKkdJnEl4Jbp15OONgSZSWULgf
	NKNrkelxAoGBAPMdV4SN0cYeQ/tly1GKvjgq4uX3YK3FJWCKB0lnrlr7tqUSPYvS
	2hw+cVHzlMlFkdCMHN2dYONk451HVB3LBEJ2FRiBQbEvdCaYQj6IkRcQBagLtMrn
	baGEGnb4Cvf4CxLC3SR9FHsGmAcaWnkYw6cgh+VAkTVEW4THiHvVxMYLAoGBANlI
	k2nJINQkwqWy02GoHA3hcpcQQjGEZqR6qimfvRSg0uhvaFfG2NjW4uU62QD5g/hn
	2Lr1LZ/pPwxKI2s1VMbumn8MB525hpaQGFwCaqX3dnzarG7Q3/uBGJbxwUMovuWJ
	eoRUkhTmp6Jpc96nCBrm85hM3qwATJWl/N6ExNqPAoGANeo97HGfIfa4UNpkWrMQ
	OFiadTGFSUQ9Y8l4kDjkG91SxgzjhUy/fiAC9Y+1YWWCTuOjyyoJwKQxLkIRT4Ik
	cbDKQOL5dJf3hE+j8UZMFvdAqeHeuFjWoUkwrU2Y8SEbI4//hwYOMrJlqL2Zbt2l
	Fj1KpfbJvSxpt2qgxAXGW70CgYA52CdeZyv1LiAfip7Zha6KR3WBH9PvaMcGjJ1W
	XW8x2aqsNFR74bUC7RoUWnlA2Cw46jR5eSH/S1H8jJQnS1hZaVX58pLoe2aIGK5T
	eFU5/8osbO6wxayLQQ/xx0RjA6rmYpYaOoV1SP5hr18obCEtQESjS/uPoLjCsiDC
	gGgDowKBgQDSFP49zJQYu05Ui4iGTgoLEg86cJ/Kx0Oqd4IFTGIqfiQjjkXxiiwb
	Ud7m/kZdmxj6rLg8XfvreFZezgav8pCNi4OZMiXGYqXuD7U+xG96/yWUvXjKL1+o
	7hreqhqhiCySHoNb+m5o36A1igNMPKCpGHFrtjNv1itELZ5gorLycg==
	-----END RSA PRIVATE KEY-----

 
 | you will need this key to configure your workstation!
 | -----------------------------------------------------

__Configure Workstation__

Now that you have your server set up. You have to configure a workstation.

Again go here [http://www.opscode.com/chef/install/](http://www.opscode.com/chef/install/) but this time select the "client" tab.

Once you got that installed; create a repo dir; you can get this by cloning a "base" config from opscode [here](https///github.com/opscode/chef-repo)

Clone the codebase

	
	me@workstation$ git clone git://github.com/opscode/chef-repo.git


Change in to the directory that was just created.

	
	me@workstation$ cd chef-repo


Remove the git directory from the cloned repository

	
	me@workstation$ rm -rf .git


Initialize (optional)

	
	me@workstation$ git init


Now make a *.chef* directory in that repo dir.

	
	me@workstation$ mkdir ~/chef-repo/.chef


Take the *USERNAME.pem* file you created (you remembered to copy it when your created the user right?!?!) and copy/move it to this directory.

	
	me@workstation$ mv USERNAME.pem ~/chef-repo/.chef/


You will now need to scp the "validator" key file to this directory. This is found under the // /etc/chef-server/ // directory on the Chef Server

	
	root@chef-server# scp /etc/chef-server/chef-validator.pem me@workstation:~/chef-repo/.chef/


You should now have 2 files on your workstation

	
	me@workstation$ ls -lAFh  ~/chef-repo/.chef/
	total 16K
	-rw-rw-r-- 1 christian christian 1.7K Feb  8 22:18 USERNAME.pem
	-rw------- 1 christian christian 1.7K Feb  8 22:19 chef-validator.pem


Now you need to configure your *knife* connector. The *knife* command is what you use to interface with the chef server (cleaver right?). This is done easily with the "configure" command

Be "smart" with your answers - it's "easy", but SO easy that you can make a dumb mistake.

	
	me@workstation$ pwd
	/home/me
	me@workstation$ knife configure
	Overwrite /home/me/chef-repo/.chef/knife.rb? (Y/N) Y
	Please enter the chef server URL: [http://chef-server:4000] https://chef-server.tld
	Please enter an existing username or clientname for the API: [christian] USERNAME
	Please enter the validation clientname: [chef-validator]
	Please enter the location of the validation key: [/etc/chef/validation.pem] /home/me/chef-repo/.chef/chef-validator.pem
	Please enter the path to a chef repository (or leave blank):


In the end...you will have 3 files in your // ~/chef-repo/.chef// dir...

	
	me@workstation$ $ ls -lAFh  ~/chef-repo/.chef/
	total 16K
	-rw-rw-r-- 1 christian christian 1.7K Feb  8 22:18 USERNAME.pem
	-rw-rw-r-- 1 christian christian  468 Feb  8 22:30 knife.rb
	-rw------- 1 christian christian 1.7K Feb  8 22:19 chef-validator.pem


Your // knife.rb // file should look something like this

	
	me@workstation$ cat ~/chef-repo/.chef/knife.rb
	
	current_dir = File.dirname(__FILE__)
	log_level                :info
	log_location             STDOUT
	environment              '4over'
	node_name                'USERNAME'
	client_key               '/home/me/chef-repo/.chef/USERNAME.pem'
	validation_client_name   'chef-validator'
	validation_key           '/home/me/chef-repo/.chef/chef-validator.pem'
	chef_server_url          'https://chef-server.tld'
	syntax_check_cache_path  '/home/me/chef-repo/.chef/syntax_check_cache'
	cookbook_path            ["#{current_dir}/../cookbooks"]


NOTE: I needed to add // **current_dir = File.dirname(__FILE__)** // and // ** cookbook_path ["#{current_dir}/../cookbooks"] ** // to this file to make it work "right" \\
ALSO: I added the // ** environment              '4over' ** // in order to default to the environment I wanted. Or else you have to specify it in the // knife // command with a // -E //

You should now be able to connect.

	
	me@workstation$ knife client list
	chef-validator
	chef-webui

